<script type="text/javascript" >
    RED.nodes.registerType('edm',{
        category: 'config',
        defaults: {
            namespace: {value:"ignite",required:true},
            entities: { type:"entity", required: false },
            scope: { value:[] },
        },
        label: function() {
            return "edm:"+ this.namespace;
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];
            this._resize = function() {
                var rows = $("#node-config-dialog-edit-form>div:not(.node-input-target-list-row)");
                var height = $("#node-config-dialog-edit-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#node-config-dialog-edit-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var dirList = $("#node-input-edm-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                });

                var candidateNodes = [];
                RED.nodes.eachConfig(function(n) {
                    if(n.type == "entity"){
                        candidateNodes.push(n);
                    }
                });
                var allChecked = true;
                var items = [];
                var nodeItemMap = {};

                candidateNodes.forEach(function(n) {
                    if (n.id === node.id) {
                        return;
                    }
                    var isChecked = scope.indexOf(n.id) !== -1;

                    allChecked = allChecked && isChecked;

                    nodeItemMap[n.id] = {
                        node: n,
                        label: n.name,
                        sublabel: n.type,
                        selected: isChecked
                    };
                    items.push(nodeItemMap[n.id]);
                });
                dirList.treeList('data',items);
        },
        oneditsave: function(){
            this.scope = $("#node-input-edm-target-container-div").treeList('selected').map(function(i) { return i.node.id});
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>

<script type="text/html" data-template-name="edm">
    <div class="form-row">
        <label for="node-config-input-namespace"><i class="fa fa-bookmark"></i> Namespace</label>
        <input type="text" id="node-config-input-namespace">
    </div>
    <div class="form-row">
        <label for="node-config-input-entities"><i class="fa fa-bookmark"></i> Entity</label>
        <input type="text" id="node-config-input-entities">
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="min-height: 100px">
        <div id="node-input-edm-target-container-div"></div>
    </div>
</script>